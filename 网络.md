### 1. http

http://www.aspxfans.com:8080/news/index.asp?boardID=5&ID=24618&page=1#name

从上面的URL可以看出，一个完整的URL包括以下几部分：

1. 协议部分：该URL的协议部分为“http：”，这代表网页使用的是HTTP协议。在Internet中可以使用多种协议，如HTTP，FTP等等本例中使用的是HTTP协议。在"HTTP"后面的“//”为分隔符
2. 域名部分：该URL的域名部分为“www.aspxfans.com”。一个URL中，也可以使用IP地址作为域名使用
3. 端口部分：跟在域名后面的是端口，域名和端口之间使用“:”作为分隔符。端口不是一个URL必须的部分，如果省略端口部分，将采用默认端口
4. 虚拟目录部分：从域名后的第一个“/”开始到最后一个“/”为止，是虚拟目录部分。虚拟目录也不是一个URL必须的部分。本例中的虚拟目录是“/news/”
5. 文件名部分：从域名后的最后一个“/”开始到“？”为止，是文件名部分，如果没有“?”,则是从域名后的最后一个“/”开始到“#”为止，是文件部分，如果没有“？”和“#”，那么从域名后的最后一个“/”开始到结束，都是文件名部分。本例中的文件名是“index.asp”。文件名部分也不是一个URL必须的部分，如果省略该部分，则使用默认的文件名

6. 锚部分：从“#”开始到最后，都是锚部分。本例中的锚部分是“name”。锚部分也不是一个URL必须的部分
7. 参数部分：从“？”开始到“#”为止之间的部分为参数部分，又称搜索部分、查询部分。本例中的参数部分为“boardID=5&ID=24618&page=1”。参数可以允许有多个参数，参数与参数之间用“&”作为分隔符。

### linux收发包

- 网卡驱动：网卡需要有驱动才能工作，驱动是加载到内核中的模块，负责衔接网卡和内核的网络模块，驱动在加载的时候将自己注册进网络模块，当相应的网卡收到数据包时，网络模块会调用相应的驱动程序处理数据。

```
                   +-----+
                   |     |                            Memroy
+--------+   1     |     |  2  DMA     +--------+--------+--------+--------+
| Packet |-------->| NIC |------------>| Packet | Packet | Packet | ...... |
+--------+         |     |             +--------+--------+--------+--------+
                   |     |<--------+
                   +-----+         |
                      |            +---------------+
                      |                            |
                    3 | Raise IRQ                  | Disable IRQ
                      |                          5 |
                      |                            |
                      ↓                            |
                   +-----+                   +------------+
                   |     |  Run IRQ handler  |            |
                   | CPU |------------------>| NIC Driver |
                   |     |       4           |            |
                   +-----+                   +------------+
                                                   |
                                                6  | Raise soft IRQ
                                                   |
                                                   ↓
```

过程：

1. 数据包从外面的网络进入物理网卡。如果目的地址不是该网卡，且该网卡没有开启混杂模式，该包会被网卡丢弃。
2. 网卡将数据包通过[DMA](https://link.segmentfault.com/?enc=45Y22GjWqnHHVt7N4713Sg%3D%3D.RTcovGyeqreqo7PEKrivSG7rR7vrhmj3zEmILuM1SkkzN8z%2B2%2FFIVNKW1VcLddtI06eQlBNQD5wpNYSTMhncvg%3D%3D)的方式写入到指定的内存地址，该地址由网卡驱动分配并初始化。注： 老的网卡可能不支持DMA，不过新的网卡一般都支持。
3. 网卡通过硬件中断（IRQ）通知CPU，告诉它有数据来了
4. CPU根据中断表，调用已经注册的中断函数，这个中断函数会调到驱动程序（NIC Driver）中相应的函数
5. 驱动先禁用网卡的中断，表示驱动程序已经知道内存中有数据了，告诉网卡下次再收到数据包直接写内存就可以了，不要再通知CPU了，这样可以提高效率，避免CPU不停的被中断。
6. 启动软中断。这步结束后，硬件中断处理函数就结束返回了。由于硬中断处理程序执行的过程中不能被中断，所以如果它执行时间过长，会导致CPU没法响应其它硬件的中断，于是内核引入软中断，这样可以将硬中断处理函数中耗时的部分移到软中断处理函数里面来慢慢处理。

##### 文章：https://segmentfault.com/a/1190000008836467

##### 文章：https://blog.packagecloud.io/eng/2016/10/11/monitoring-tuning-linux-networking-stack-receiving-data-illustrated/

##### 文章：https://blog.packagecloud.io/eng/2016/06/22/monitoring-tuning-linux-networking-stack-receiving-data/



### k8 网络协议解析

#### 基础知识

##### route

```shell
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.8.1     0.0.0.0         UG    100    0        0 em1
10.244.0.0      10.244.0.0      255.255.255.0   UG    0      0        0 flannel.1
10.244.1.0      0.0.0.0         255.255.255.0   U     0      0        0 cni0
10.244.2.0      10.244.2.0      255.255.255.0   UG    0      0        0 flannel.1
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0
192.168.8.0     0.0.0.0         255.255.252.0   U     100    0        0 em1
```

在路由表的输出中，每一行都包含了以下几个字段：

1. **Destination**（目标地址）：表示数据包要到达的目标地址或目标网络的IP地址。这个字段指定了数据包的最终目的地。
2. **Gateway**（网关）：指定了数据包应该经过哪个路由网关来到达目标地址。网关通常是一个路由器或者中间设备，它负责将数据包从本地网络发送到目标网络。
3. **Genmask**（子网掩码）：子网掩码指定了目标地址或目标网络的范围。它用于确定哪些地址属于同一目标网络。通常以CIDR（Classless Inter-Domain Routing）格式表示，例如，255.255.255.0 或 /24。
4. **Flags**（标志）：这是一个描述路由属性的字段，通常包括以下标志：
   - **U**（Up）：表示路由是活动的，可以使用。
   - **G**（Gateway）：表示这是一个网关路由，需要将数据包发送到指定的网关以进行转发。
   - **H**（Host）：表示这是一个主机路由，目标是一个具体的主机而不是一个网络。
   - **D**（Dynamic）：表示路由是动态生成的，通常由路由协议（如BGP、OSPF等）生成。
   - **C**（Cache）：表示路由是从缓存中获取的。
5. **Metric**（跃点）：跃点值用于确定路由的优先级。较低的跃点值通常表示较高的优先级，数据包将选择具有最低跃点值的路由。
6. **Ref**（参考次数）：表示有多少个路由表项引用了这个路由。这对于确定哪些路由是活动的非常有用。
7. **Use**（使用次数）：表示有多少个数据包已经通过这个路由表项进行了路由。
8. **Iface**（接口）：指定了数据包将通过哪个网络接口发送。这是一个与路由表项相关联的网络接口的名称。



```shell
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
10.244.1.0      0.0.0.0         255.255.255.0   U     0      0        0 cni0
```

- **Destination**（目标地址）：`10.244.1.0` 表示这是一个目标网络的IP地址。这个目标网络的IP地址范围是 `10.244.1.0` 到 `10.244.1.255`，使用了子网掩码 `255.255.255.0`，表示这是一个/24子网。
- **Gateway**（网关）：`0.0.0.0` 表示没有明确的网关，通常表示这个目标网络是本地网络（直连网络）。这意味着数据包将直接发送到目标网络上的主机，而不需要经过中间网关。
- **Genmask**（子网掩码）：`255.255.255.0` 是目标网络的子网掩码，它指定了目标网络的范围。
- **Flags**（标志）：`U` 表示这是一个直连路由（Connected），这意味着数据包将直接发送到目标网络上的主机，而不需要经过网关。
- **Metric**（跃点）：`0` 表示这个路由的跃点值。跃点用于确定路由的优先级，较低的跃点值通常表示较高的优先级。

这一行表示一个直连路由，将数据包发送到目标网络 `10.244.1.0/24`，并且数据包将直接发送到这个网络上的主机，而不需要经过网关。该路由项使用了网络接口 `cni0` 来进行数据包的发送和接收。



```shell
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.8.0     0.0.0.0         255.255.252.0   U     100    0        0 em1
```



这行路由规则表示的是一个在 Linux 系统下配置的静态路由。我们可以逐部分地解释它：

1. **目的网络地址 (192.168.8.0)**: 这是目标网络的 IP 地址。在这个例子中，192.168.8.0 表示一个私有（本地）网络地址。
2. **网关地址 (0.0.0.0)**: 这个字段指示用于到达目的地的网关。0.0.0.0 表示没有特定网关，即直接路由到目的网络。
3. **子网掩码 (255.255.252.0)**: 这是网络掩码，用于确定 IP 地址中哪部分是网络地址，哪部分是主机地址。在这个例子中，255.255.252.0 表示子网掩码，允许网络地址从 192.168.8.0 到 192.168.11.255。

这行路由规则意味着所有发往 192.168.8.0/22（即从 192.168.8.0 到 192.168.11.255）网络的数据包都将直接通过 em1 接口发送，不需要经过任何网关。

```shell
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
10.244.2.0      10.244.2.0      255.255.255.0   UG    0      0        0 flannel.1
```

1. **目的网络地址 (10.244.2.0)**: 这是目标网络的 IP 地址。10.244.2.0 是一个私有（本地）网络地址。
2. **网关地址 (10.244.2.0)**: 这个字段指示用于到达目的地的网关。这里的网关地址和目的网络地址相同，这在某些特殊配置中是可能的，特别是在虚拟网络或特定类型的 VPN 配置中。
3. **子网掩码 (255.255.255.0)**: 这是网络掩码，用于确定 IP 地址中的网络和主机部分。255.255.255.0 表示子网掩码，允许网络地址为 10.244.2.0 到 10.244.2.255。

这条路由规则表示所有发往 10.244.2.0/24 网络的数据包应该通过虚拟接口 "flannel.1" 传输，并且即使目的地和网关地址相同，也需要通过一个网关来路由这些数据包。这种配置通常见于虚拟化环境或复杂的网络设置中。

##### iptables

![](network/iptables01.png)



#### 几个常用命令

```bash
#用来查看所有的bridge 和与bridge相连接的veth
[root@tgq205 ~]# brctl show
bridge name     bridge id               STP enabled     interfaces
cni0            8000.9652de6b60b3       no              veth0fccc29b
                                                        veth1eb2e7ad
                                                        veth2399fb7c
                                                        veth2f4bf872
                                                        veth5f05b485
                                                        veth6ef22d85
                                                        vethb57e0ef7
                                                        vethbf16690b
                                                        vethf8f10afb
docker0         8000.0242f5ca3ed3       no
```















































